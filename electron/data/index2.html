<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Synaps</title>

  <style type="text/css">
    html,
    body {
      height: 100%;
      margin: 0px;
      padding: 0px;
      background-color: black;
      overflow: hidden;
    }

    #display-div {
      height: 100%;
      transition: background-image 1s ease-in-out;
      background-size: contain;
      background-repeat: no-repeat;
      color: white;
      font-size: 100px;
    }

    #user-ct {
      float: right;
      font-size: 30px;
      color: white;
      padding: 15px;
    }

    iframe {
      position: fixed;
      right: 0;
      bottom: 0;
      min-width: 100%;
      min-height: 100%;
      width: auto;
      height: auto;
      /* z-index: -100; */
    }

  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery-tubeplayer/2.1.0/jquery.tubeplayer.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.3.1/firebase.js"></script>

  <script>
    $(document).ready(function () {
      // $('#display-div').css('background-image', 'url(http://www.art-dept.net/wp-content/uploads/2013/03/blue_label.jpg)');
      var _socket;
      var _ads;
      var _deviceId;
      var _adSetId;

      var fb = firebase.initializeApp({
        databaseURL: "https://synaps-demo.firebaseio.com/", // Realtime Database
      });

      fb.database().ref('ads').on('value', function (dataSnapshot) {
        _ads = dataSnapshot.val();
      });


      var index = 0;

      function init() {
        var src = 'http://localhost:3003/';
        _socket = io(src);
        _socket.on('connect', function () {
          console.log('connected');

          _socket.on('media-change', function (data) {
            // changeMedia(data);
            if (data.userct != null) {
              $('#user-ct').html(data.userct);
            }
          });

          _socket.emit('config', {}, function (data) {
            _deviceId = data['device-id'];
            //_adSetId = parseInt(data['ad-set-id']);
            fb.database().ref('devices/' + _deviceId + 'AD_SET_ID').on('value', function(data){
              _adSetId = data.val();
            });
          });

        });

        _socket.on('disconnect', function () {});
      }

      var chInt = setInterval(function () {
        if (_adSetId == null)
          return;

        var ad = _ads[_adSetId].set[index];
        _socket.emit('ad-change', {
          url: ad.image == null ? ad.video : ad.image
        });

        changeMedia(ad.image, ad.video);

        index++;
        if (index >= _ads[_adSetId].set.length)
          index = 0;

        if (ad.video != null)
          clearInterval(chInt);
      }, 8000);

      init();
    })

    function changeMedia(image, video) {
      if (image != null) {
        $('#vid-div').hide();
        //  $('#display-div').show();
        $('#display-div').css('background-image', 'url(' + image + ')');
      } else {
        //$('#vid-div').show();
        $('#display-div').hide();
        // youtube
        $('#vid-frame').prop('src', 'https://www.youtube.com/embed/' + video + '?controls=0&autoplay=1&loop=1&playlist=' + video);
        // $('#vid-div').tubeplayer({
        //   initialVideo: video,
        //   controls: 0,
        //   loop: 1000,/
        //   modestbranding: false,
        //   autoPlay: 1,
        //   //width: $(document).width(),
        //   //height: $(document).height(),
        //   // onPlayerLoaded: function(){
        //   //   alert("that was awesome!"); 
        //   //   },
        //   // onPlayerPlaying: function(){console.log("PLAYING")},
        //   // onPlayerEnded: function () {
        //   //   console.log('END')
        //   //   $('#vid-div').tubeplayer("play");
        //   // }
        // });
      }
    }

  </script>
</head>

<body>
  <iframe id="vid-frame" width="420" height="315" frameborder="0" allowfullscreen></iframe>
  <div id="display-div">
    <div id="user-ct"></div>
  </div>
</body>

</html>
